function onFinishRender(e){function t(t,r,n){t.$last===!0&&e(function(){console.log("Finished last render"),t.$evalAsync(n.onFinishRender)})}return{link:t}}function focusOn(){function e(e,t,r){e.$on("focusOn",function(e,n){n===r.focusOn&&t[0].focus()})}return e}function addableNzb(){function e(e,t){e.classname="nzb",e.add=function(){e.classname="nzb-spinning";var r=new URI("/internalapi/addnzb");r.addQuery("title",e.item.title),r.addQuery("providerguid",e.item.providerguid),r.addQuery("provider",e.item.provider),t.get(r).success(function(t){"Success"==t?e.classname="nzb-success":e.classname="nzb-error"}).error(function(){})}}return{templateUrl:"/static/html/directives/addable-nzb.html",require:"^item",scope:{item:"="},controller:["$scope","$http",e]}}function SearchService(e){function t(t,r,i,a,s,l,c,u,d,f,g,p){console.log("Category: "+t);var m;return t.indexOf("Movies")>-1?(console.log("Search for movies"),m=new URI("/internalapi/moviesearch"),i?(console.log("moviesearch per imdbid"),m.addQuery("imdbid",i),m.addQuery("title",a)):(console.log("moviesearch per query"),m.addQuery("query",r))):t.indexOf("TV")>-1?(console.log("Search for shows"),m=new URI("/internalapi/tvsearch"),s&&(m.addQuery("tvdbid",s),m.addQuery("title",a)),""!=l&&m.addQuery("season",l),""!=c&&m.addQuery("episode",c)):(console.log("Search for all"),m=new URI("/internalapi/search"),m.addQuery("query",r)),_.isNullOrEmpty(u)||m.addQuery("minsize",u),_.isNullOrEmpty(d)||m.addQuery("maxsize",d),_.isNullOrEmpty(f)||m.addQuery("minage",f),_.isNullOrEmpty(g)||m.addQuery("maxage",g),m.addQuery("category",t),console.log("Calling "+m),o=m,e.get(m).then(n)}function r(t){return o.removeQuery("offset"),o.addQuery("offset",t),console.log("Calling "+o),e.get(o).then(n)}function n(e){var t=e.data.results,r=e.data.providersearches,n=e.data.total,o=t.length;return _.each(r,function(e){e.averageResponseTime=_.reduce(e.api_accesses,function(e,t){return e+t.response_time},0),e.averageResponseTime=e.averageResponseTime/e.api_accesses.length}),{results:t,providersearches:r,total:n,resultsCount:o}}var o,i={search:t,loadMore:r};return i}function SearchResultsController(e,t,r,n,o,i,a,s,l,c){function u(e){return e[0][t.sortPredicate]}function d(e){return e[0][0].title}function f(e){console.log("Blocking");var t=r.defer();return o.start(e),n(function(){t.resolve()},100),t.promise}function g(e,r){f("Sorting / filtering...").then(function(){e==t.sortPredicate?t.sortReversed=!t.sortReversed:t.sortReversed=r,t.sortPredicate=e,t.filteredResults=p(t.results),o.reset()})}function p(e){e=_.filter(e,function(e){return t.providerDisplayState[e.provider]}),e=_.groupBy(e,function(e){return e.hash}),e=_.groupBy(e,function(e){return e[0].title.toLowerCase()}),e=_.map(e,function(e){var r=_.sortBy(e,function(e){return e[0][t.sortPredicate]});return t.sortReversed&&r.reverse(),r});var r=_.sortBy(e,function(e){return e[0][0][t.sortPredicate]});return t.sortReversed&&r.reverse(),console.log(r),r}function m(){o.reset()}function h(){t.offset+=100,console.log("Increasing the offset to "+t.offset),f("Loading more results...").then(function(){i.loadMore(t.offset).then(function(e){console.log("Returned more results:"),console.log(e.results),console.log(t.results),console.log("Total: "+e.total),t.results=t.results.concat(e.results),t.filteredResults=p(t.results),t.total=e.total,t.resultsCount+=e.resultsCount,console.log("Total results in $scope.results: "+t.results.length),m()})})}function v(){f("Filtering. Sorry...").then(function(){t.filteredResults=p(t.results)}).then(function(){m()})}function y(){return t.results.length}function b(e){if(e.has_nfo){var r=new URI("/internalapi/getnfo");return r.addQuery("provider",e.provider),r.addQuery("guid",e.providerguid),a.get(r).then(function(e){e.data.has_nfo?t.openModal("lg",e.data.nfo):c.info("No NFO available")})}}function z(e,t){var r=s.open({template:'<pre><span ng-bind-html="nfo"></span></pre>',controller:"ModalInstanceCtrl",size:e,resolve:{nfo:function(){return l.trustAsHtml(t)}}});r.result.then()}t.sortPredicate="epoch",t.sortReversed=!0,t.limitTo=101,t.offset=0,t.providersearches=e.providersearches,t.providerDisplayState=[],t.providerResultsInfo={},t.groupExpanded={},_.forEach(t.providersearches,function(e){t.providerDisplayState[e.provider]=!0}),_.forEach(t.providersearches,function(e){t.providerResultsInfo[e.provider]={loadedResults:e.loaded_results}}),t.results=e.results,t.total=e.total,t.resultsCount=e.resultsCount,t.filteredResults=p(t.results),m(),t.firstResultPredicate=u,t.groupId=d,t.setSorting=g,t.stopBlocking=m,t.loadMore=h,t.toggleProviderDisplay=v,t.countResults=y,t.showNfo=b,t.openModal=z}function SearchController(e,t,r,n,o,i,a,s,l,c,u){console.log("Start of search controller"),e.category="undefined"==typeof r.category||""==r.category?"All":r.category,e.query="undefined"==typeof r.query?"":r.query,e.imdbid="undefined"==typeof r.imdbid?"":r.imdbid,e.tvdbid="undefined"==typeof r.tvdbid?"":r.tvdbid,e.title="undefined"==typeof r.title?"":r.title,e.season="undefined"==typeof r.season?"":r.season,e.episode="undefined"==typeof r.episode?"":r.episode,e.minsize="undefined"==typeof r.minsize?"":r.minsize,e.maxsize="undefined"==typeof r.maxsize?"":r.maxsize,e.minage="undefined"==typeof r.minage?"":r.minage,e.maxage="undefined"==typeof r.maxage?"":r.maxage,e.selectedProviders="undefined"==typeof r.providers?"":r.providers,e.showProviders={};var d;""!=e.title&&""==e.query&&(e.query=e.title),e.typeAheadWait=300,e.selectedItem="",e.autocompleteLoading=!1,e.isAskById=!1,e.isById={value:!0},e.availableProviders=[],e.autocompleteClass="autocompletePosterMovies",e.toggle=function(t){if(e.category=t,e.isAskById=e.category.indexOf("TV")>-1||e.category.indexOf("Movies")>-1,s("focus-query-box"),e.query="",d.settings.searching.categorysizes.enable_category_sizes){var r=d.settings.searching.categorysizes[t+" min"],n=d.settings.searching.categorysizes[t+" max"];_.isNumber(r)?e.minsize=r:e.minsize="",_.isNumber(n)?e.maxsize=n:e.maxsize=""}},e.getAutocomplete=function(r){return e.autocompleteLoading=!0,e.isById.value?e.category.indexOf("Movies")>-1?t.get("/internalapi/autocomplete?type=movie",{params:{input:r}}).then(function(t){return e.autocompleteLoading=!1,t.data.results}):e.category.indexOf("TV")>-1?t.get("/internalapi/autocomplete?type=tv",{params:{input:r}}).then(function(t){return e.autocompleteLoading=!1,t.data.results}):{}:{}},e.startSearch=function(){c.start("Searching..."),a.search(e.category,e.query,e.imdbid,e.title,e.tvdbid,e.season,e.episode,e.minsize,e.maxsize,e.minage,e.maxage,e.selectedProviders).then(function(t){i.go("search.results",{results:t.results,providersearches:t.providersearches,total:t.total,resultsCount:t.resultsCount}),e.imdbid="",e.tvdbid=""})},e.goToSearchUrl=function(){var t={};""!=e.imdbid?(t.imdbid=e.imdbid,t.title=e.title):""!=e.tvdbid?(t.tvdbid=e.tvdbid,t.title=e.title,""!=e.season&&(t.season=e.season),""!=e.episode&&(t.episode=e.episode)):t.query=e.query,""!=e.minsize&&(t.minsize=e.minsize),""!=e.maxsize&&(t.maxsize=e.maxsize),""!=e.minage&&(t.minage=e.minage),""!=e.maxage&&(t.maxage=e.maxage),t.category=e.category,console.log("Going to search state with params..."),console.log(t),i.go("search",t,{inherit:!1})},e.selectAutocompleteItem=function(t){e.selectedItem=t,e.title=t.label,e.category.indexOf("Movies")>-1?e.imdbid=t.value:e.category.indexOf("TV")>-1&&(e.tvdbid=t.value),e.query="",e.goToSearchUrl()},e.autocompleteActive=function(){return e.category.indexOf("TV")>-1||e.category.indexOf("Movies")>-1},e.seriesSelected=function(){return e.category.indexOf("TV")>-1},l.get().then(function(t){d=t,e.availableProviders=_.filter(t.settings.providers,function(e){return e.enabled}).map(function(e){return{name:e.name,activated:!0}}),console.log(e.availableProviders)}),"landing"!=r.mode&&(console.log("Came from search url, will start searching"),e.startSearch())}function ConfigService(e,t){function r(t){console.log("Starting setConfig"),e.put("/internalapi/setsettings",t).then(function(e){console.log("Settings saved. Updating cache"),o.settings=t},function(e){console.log("Error saving settings: "+e)})}function n(){function r(){if(!angular.isUndefined(o)){var r=t.defer();return r.resolve(o),console.log("Returning config from cache"),r.promise}return e.get("/internalapi/getconfig").then(function(e){return console.log("Updating config cache"),o=e.data,e.data})}return r().then(function(e){return{schema:e.schema,settings:e.settings,form:e.form}})}var o,i={set:r,get:n};return i}function ConfigController(e,t,r,n){function o(){return e.$on("sf-render-finished",function(){n.reset(),console.log("Render of form finished")}),n.start("Loading config..."),r.get().then(function(t){e.model=t.settings,e.schema=t.schema,e.form=t.form})}o(),e.onSubmit=function(t){e.$broadcast("schemaFormValidate"),t.$valid&&r.set(e.model)}}var nzbhydraapp=angular.module("nzbhydraApp",["angular-loading-bar","ngAnimate","ui.bootstrap","ipCookie","angular-growl","angular.filter","filters","ui.router","blockUI","schemaForm","mgcrea.ngStrap","angularUtils.directives.dirPagination"]);angular.module("nzbhydraApp").config(["$stateProvider","$urlRouterProvider","$locationProvider","blockUIConfig",function(e,t,r,n){n.autoBlock=!1,e.state("home",{url:"/",templateUrl:"/static/html/states/search.html",controller:"SearchController",params:{mode:"landing"}}).state("search",{url:"/search?category&query&imdbid&tvdbid&title&season&episode&minsize&maxsize&minage&maxage&offsets",templateUrl:"/static/html/states/search.html",controller:"SearchController",params:{category:"All",mode:"search"}}).state("search.results",{templateUrl:"/static/html/states/search-results.html",controller:"SearchResultsController",options:{inherit:!1},params:{results:[],providersearches:[],total:0,resultsCount:0,mode:"results"}}).state("config",{url:"/config",templateUrl:"/static/html/states/config.html",controller:"ConfigController"}),r.html5Mode(!0)}]),nzbhydraapp.config(["paginationTemplateProvider",function(e){e.setPath("/static/html/dirPagination.tpl.html")}]),nzbhydraapp.config(["$httpProvider",function(e){var t=["$location","$q","$injector",function(e,t,r){function n(e){return e}function o(e){return 401===e.status?(r.get("$state").transitionTo("public.login"),t.reject(e)):t.reject(e)}return function(e){return e.then(n,o)}}];e.interceptors.push(t)}]),nzbhydraapp.config(["cfpLoadingBarProvider",function(e){e.latencyThreshold=100}]),nzbhydraapp.config(["growlProvider",function(e){e.globalTimeToLive(5e3),e.globalPosition("bottom-right")}]),nzbhydraapp.directive("ngEnter",function(){return function(e,t,r){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$evalAsync(r.ngEnter)}),t.preventDefault())})}}),nzbhydraapp.controller("ModalInstanceCtrl",["$scope","$modalInstance","nfo",function(e,t,r){e.nfo=r,e.ok=function(){t.close(e.selected.item)},e.cancel=function(){t.dismiss()}}]),nzbhydraapp.filter("nzblink",function(){return function(e){var t=new URI("/internalapi/getnzb");return t.addQuery("guid",e.guid),t.addQuery("title",e.title),t.addQuery("provider",e.provider),t.toString()}}),nzbhydraapp.factory("focus",["$rootScope","$timeout",function(e,t){return function(r){t(function(){e.$broadcast("focusOn",r)})}}]),_.mixin({isNullOrEmpty:function(e){return _.isUndefined(e)||_.isNull(e)||0===e.trim().length}}),angular.module("nzbhydraApp").directive("onFinishRender",onFinishRender),onFinishRender.$inject=["$timeout"],angular.module("nzbhydraApp").directive("focusOn",focusOn),angular.module("nzbhydraApp").directive("addableNzb",addableNzb),angular.module("nzbhydraApp").factory("SearchService",SearchService),SearchService.$inject=["$http"],_.mixin({isNullOrEmpty:function(e){return _.isUndefined(e)||_.isNull(e)||0===e.trim().length}}),angular.module("nzbhydraApp").controller("SearchResultsController",SearchResultsController),SearchResultsController.$inject=["$stateParams","$scope","$q","$timeout","blockUI","SearchService","$http","$uibModal","$sce","growl"],angular.module("nzbhydraApp").controller("SearchController",SearchController),SearchController.$inject=["$scope","$http","$stateParams","$uibModal","$sce","$state","SearchService","focus","ConfigService","blockUI","growl"];var HEADER_NAME="MyApp-Handle-Errors-Generically",specificallyHandleInProgress=!1;nzbhydraapp.factory("RequestsErrorHandler",["$q","growl",function(e,t){return{specificallyHandled:function(e){specificallyHandleInProgress=!0;try{return e()}finally{specificallyHandleInProgress=!1}},responseError:function(t){var r=t&&t.config&&t.config.headers&&t.config.headers[HEADER_NAME];if(r){var n="An error occured:<br>"+t.status+": "+t.statusText;t.data&&(n+="<br><br>"+t.data),alert(n)}return e.reject(t)}}}]),nzbhydraapp.config(["$provide","$httpProvider",function(e,t){function r(e){return e=e||{},e.headers=e.headers||{},specificallyHandleInProgress||(e.headers[HEADER_NAME]=!0),e}t.interceptors.push("RequestsErrorHandler"),e.decorator("$http",["$delegate",function(e){function t(t){return function(n,o){return e[t](n,r(o))}}function n(t){return function(n,o,i){return e[t](n,o,r(i))}}function o(t){for(var r in e)t.hasOwnProperty(r)||("function"==typeof e[r]?t[r]=function(){return e.apply(e,arguments)}:t[r]=e[r])}var i=function(t){return e(r(t))};return i.get=t("get"),i["delete"]=t("delete"),i.head=t("head"),i.jsonp=t("jsonp"),i.post=n("post"),i.put=n("put"),o(i),i}])}]);var filters=angular.module("filters",[]);filters.filter("bytes",function(){return function(e,t){if(isNaN(parseFloat(e))||!isFinite(e)||0==e)return"-";"undefined"==typeof t&&(t=1);var r=["b","kB","MB","GB","TB","PB"],n=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,Math.floor(n))).toFixed(t)+r[n]}}),filters.filter("unsafe",["$sce",function(e){return e.trustAsHtml}]),angular.module("nzbhydraApp").factory("ConfigService",ConfigService),ConfigService.$inject=["$http","$q"],angular.module("nzbhydraApp").controller("ConfigController",ConfigController),ConfigController.$inject=["$scope","$http","ConfigService","blockUI"];
//# sourceMappingURL=nzbhydra.js.map
